![](https://penlab-1252869057.cos.ap-beijing.myqcloud.com/2022-01-15-093053.png)

# 0x01 背景&动机

本文通过黑盒+ML的方法来探测CSRF这种漏洞。
CSRF是WEB应用中的一个常见的漏洞。这种洞的主要危害是攻击者可以伪造任意表单来欺骗受害者提交。 自动化检测这个洞有两个难点: 
1. 如何自动化的识别出敏感的表单提交（敏感请求）
2. 识别验证是否充分(我猜的)
对于之前的工作，Deemon是第一个解决CSRF的工作，使用了白盒技术，因此喷了他只适用于PHP应用的检测。
其他的黑盒工具多是启发式去找敏感请求的，存在大量的误报，因此大家通常还使用Burp之类的代理去找。
因此本文提出了一个基于机器学习的黑盒CSRF探测工具:Mithch

> 本文贡献：
1. 构建了一个包含5,828个HTTP request,并标记了939个敏感请求，公开了一个ground truth。
2. 基于这个数据集，分析了敏感与不敏感请求之间的差异，做了一个特征工程分析，构建了一个classifiers。
3. 使用classifer构建了Mitch，一个黑盒CSRF漏洞自动检测工具。
4. 在20个网站中发现了35个CSRF，从Deemon的中发现了

# 0x02 设计&挑战
##  CSRF攻击描述(Attack Description)
    1. Alice登陆不安全网站A，并该通过身份验证。
    2. Alice使用当前浏览器访问了攻击者伪造的网站B，"不小心"触发了一个攻击者设计的跨站请求(即B网站嵌入了一个A网站的请求表单)。
    3. Alice虽然是从B站(不是那个B站)的页面发送给A站的服务器，但是A站只知道这个请求是Alice的浏览器发来的啊(Session)。 这样，只要攻击者在B站伪造A站的任何表单请求都可以让A点。相当于攻击者通过B站操纵了Alice在A站的账户。

## 如何防护(Current Fixes and Mitigations)
    1. 通过Referer头或Origin头检查请求来源(可伪造)
    2. 功过检查是否包含X-Requested-With，来检测同源请求。
    3. 表单内加token(最常用)

## 数据集构造
收集一个请求数据集，表明哪些是敏感请求，哪些是不敏感请求。首先定义一下敏感请求：

__敏感请求:__ 1. 会导致处理它的web程序与安全相关的状态改变。(如修改账户密码) 2. 一定是在已注册用户登录后的上下文中处理该表单(即用户的私有区域，如你的个人页面)。

> 挑战： 只有在识别敏感请求后才能制造csrf攻击表单，而识别敏感请求的难点在于既要理解web程序的语义信息，又要观察服务器的变化

